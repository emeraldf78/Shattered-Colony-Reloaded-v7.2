name: Build Latest Version
on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Find Latest Version and Build
        run: |
          # 1. Find all .xcodeproj files, sort them by name (v7 > v6), and take the top one
          PROJ_PATH=$(find . -name "*.xcodeproj" | sort -V | tail -n 1)
          echo "Building the latest version found at: $PROJ_PATH"
          
          # 2. Extract the folder name for the IPA (e.g., ShatteredColony_v7)
          VERSION_NAME=$(basename $(dirname "$PROJ_PATH"))
          echo "VERSION_NAME=$VERSION_NAME" >> $GITHUB_ENV
          
          # 3. Detect the Scheme inside that specific project
          SCHEME_NAME=$(xcodebuild -list -project "$PROJ_PATH" | awk '/Schemes:/{flag=1;next} flag{print;exit}' | xargs)
          echo "Detected Scheme: $SCHEME_NAME"
          
          # 4. Build the Archive
          xcodebuild clean archive \
            -project "$PROJ_PATH" \
            -scheme "$SCHEME_NAME" \
            -archivePath "./build/Output.xcarchive" \
            -sdk iphoneos \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            AD_HOC_CODE_SIGNING_ALLOWED=YES

      - name: Create IPA Payload
        run: |
          APP_PATH=$(find ./build/Output.xcarchive -name "*.app" -type d -print -quit)
          mkdir -p Payload
          cp -r "$APP_PATH" Payload/
          zip -r "${{ env.VERSION_NAME }}.ipa" Payload

      - name: Upload Result
        uses: actions/upload-artifact@v4
        with:
          name: "${{ env.VERSION_NAME }}-IPA"
          path: "${{ env.VERSION_NAME }}.ipa"
